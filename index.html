<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vibe Scanner</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark; }
    body { font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    .glass { backdrop-filter: blur(16px); background: rgba(255,255,255,0.02); }
    .accent { color: #7dd3fc; }
    .accent-bg { background: linear-gradient(90deg, #7dd3fc, #a78bfa); }
    .card { background: #0f172a; border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 10px 40px rgba(0,0,0,0.35); }
    .shimmer { position: relative; overflow: hidden; }
    .shimmer::after { content:''; position:absolute; inset:0; transform: translateX(-100%); background: linear-gradient(120deg, transparent, rgba(255,255,255,0.08), transparent); animation: shimmer 1s ease-in-out infinite; }
    @keyframes shimmer { 100% { transform: translateX(100%); } }
    .fade-in { animation: fadeIn 400ms ease; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(6px);} to {opacity:1; transform: translateY(0);} }
  </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-6 space-y-8">
    <!-- Top bar -->
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl accent-bg flex items-center justify-center text-slate-900 font-bold shadow-lg">VS</div>
        <div>
          <p class="text-lg font-semibold">Vibe Scanner</p>
          <p class="text-sm text-slate-400">Feel your words before you send.</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="historyBtn" class="px-3 py-2 rounded-xl border border-slate-700 hover:border-slate-500 transition text-sm">History</button>
        <button id="settingsBtn" class="px-3 py-2 rounded-xl border border-slate-700 hover:border-slate-500 transition text-sm">Settings</button>
      </div>
    </header>

    <!-- Hero -->
    <section class="grid md:grid-cols-2 gap-6 items-center">
      <div class="space-y-3">
        <h1 class="text-3xl md:text-4xl font-bold tracking-tight">See how your words land.</h1>
        <p class="text-slate-300 text-lg">Instant vibe read + rewrites. Fast, private, and simple.</p>
        <p class="text-xs text-slate-500">Guidance only. Not a diagnostic tool.</p>
        <div class="flex items-center gap-3 mt-4">
          <div class="flex-1 h-2 rounded-full bg-slate-800 overflow-hidden">
            <div id="streakBar" class="h-full accent-bg" style="width: 0%"></div>
          </div>
          <div class="text-sm text-slate-300"><span id="streakCount">0</span>-day streak · Level <span id="levelLabel">1</span></div>
        </div>
      </div>
      <div class="card rounded-2xl p-4 space-y-3">
        <p class="text-sm font-semibold text-slate-200">Daily Vibe Challenge</p>
        <p id="dailyPrompt" class="text-slate-300"></p>
        <div class="flex gap-2">
          <button id="usePromptBtn" class="px-3 py-2 rounded-xl bg-white/5 hover:bg-white/10 border border-slate-700 text-sm">Use this prompt</button>
          <span id="challengeStatus" class="text-xs text-slate-500 self-center"></span>
        </div>
        <p class="text-xs text-slate-500">Complete it to build your streak.</p>
      </div>
    </section>

    <!-- Input card -->
    <section class="card rounded-2xl p-6 space-y-4">
      <div class="flex items-center justify-between gap-3">
        <div>
          <p class="text-lg font-semibold">Paste your message</p>
          <p class="text-sm text-slate-400">Context + tone goals help sharpen the read.</p>
        </div>
        <label class="flex items-center gap-2 text-sm text-slate-300 cursor-pointer" id="proToggle">
          <input type="checkbox" disabled class="accent-sky-300 bg-slate-900 border-slate-700 rounded" />
          <span>Pro (locked)</span>
        </label>
      </div>
      <textarea id="messageInput" rows="5" class="w-full bg-slate-900 border border-slate-800 rounded-2xl p-4 text-slate-100 focus:outline-none focus:border-sky-400" placeholder="Example: 'Hey! Just checking in about the proposal—want to be sure we're aligned before I loop in the team.'"></textarea>
      <div class="flex flex-wrap gap-2">
        <p class="text-sm text-slate-400 mr-2">Context:</p>
        <div id="contextChips" class="flex flex-wrap gap-2"></div>
      </div>
      <div class="flex flex-wrap gap-2">
        <p class="text-sm text-slate-400 mr-2">Tone goals (max 2):</p>
        <div id="toneChips" class="flex flex-wrap gap-2"></div>
      </div>
      <div class="flex items-center gap-3">
        <p class="text-sm text-slate-400">Tone dial</p>
        <input id="toneDial" type="range" min="0" max="100" value="50" class="w-full accent-sky-300" />
        <p class="text-sm text-slate-300 w-24 text-right"><span id="toneLabel">Balanced</span></p>
      </div>
      <div class="flex flex-wrap gap-3">
        <button id="scanBtn" class="px-4 py-3 rounded-xl bg-sky-400 text-slate-900 font-semibold hover:scale-[1.01] transition shadow-lg">Scan vibe</button>
        <button id="demoBtn" class="px-4 py-3 rounded-xl border border-slate-700 text-slate-200 hover:border-slate-500 transition">Try a demo</button>
      </div>
    </section>

    <!-- Results -->
    <section id="resultsSection" class="grid md:grid-cols-2 gap-4 opacity-0 pointer-events-none transition">
      <div class="card rounded-2xl p-5 space-y-4" id="profileCard">
        <div class="flex items-center justify-between">
          <p class="font-semibold">Vibe Profile</p>
          <span class="text-xs text-slate-500">Deterministic preview</span>
        </div>
        <div id="sliderContainer" class="space-y-3"></div>
      </div>
      <div class="card rounded-2xl p-5 space-y-4" id="interpretationCard">
        <div class="flex items-center justify-between">
          <p class="font-semibold">How it may land</p>
          <span class="text-xs text-slate-500">Headlines</span>
        </div>
        <ul id="interpretations" class="list-disc list-inside text-slate-300 space-y-2"></ul>
      </div>
      <div class="card rounded-2xl p-5 space-y-4 md:col-span-2" id="rewritesCard">
        <div class="flex items-center justify-between">
          <p class="font-semibold">Rewrite options</p>
          <span class="text-xs text-slate-500">Pick a vibe</span>
        </div>
        <div id="rewrites" class="grid md:grid-cols-3 gap-3"></div>
      </div>
      <div class="card rounded-2xl p-5 space-y-3" id="nextMoveCard">
        <p class="font-semibold">Best next move</p>
        <p id="nextMove" class="text-slate-300"></p>
      </div>
    </section>
  </div>

  <!-- History Modal -->
  <div id="historyModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4">
    <div class="card rounded-2xl max-w-2xl w-full p-6 space-y-4 max-h-[80vh] overflow-y-auto">
      <div class="flex items-center justify-between">
        <p class="text-lg font-semibold">Recent scans</p>
        <button id="closeHistory" class="text-slate-400 hover:text-white">✕</button>
      </div>
      <ul id="historyList" class="space-y-3 text-sm"></ul>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4">
    <div class="card rounded-2xl max-w-lg w-full p-6 space-y-4">
      <div class="flex items-center justify-between">
        <p class="text-lg font-semibold">Settings</p>
        <button id="closeSettings" class="text-slate-400 hover:text-white">✕</button>
      </div>
      <div class="space-y-3 text-sm">
        <label class="flex items-center justify-between">
          <span>Local history</span>
          <button id="clearHistory" class="px-3 py-1 rounded-lg bg-white/5 hover:bg-white/10 text-xs">Clear</button>
        </label>
        <label class="flex items-center justify-between">
          <span>Reset streak</span>
          <button id="resetStreak" class="px-3 py-1 rounded-lg bg-white/5 hover:bg-white/10 text-xs">Reset</button>
        </label>
      </div>
      <p class="text-xs text-slate-500">Data is stored locally in your browser (vs_history / vs_streak / vs_settings).</p>
    </div>
  </div>

  <!-- Pro Modal -->
  <div id="proModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4">
    <div class="card rounded-2xl max-w-md w-full p-6 space-y-4">
      <div class="flex items-center justify-between">
        <p class="text-lg font-semibold">Pro coming soon</p>
        <button id="closePro" class="text-slate-400 hover:text-white">✕</button>
      </div>
      <p class="text-slate-300 text-sm">Anchor pricing: <span class="font-semibold">$9/mo</span> · Founding price: <span class="font-semibold text-sky-300">$3/mo</span></p>
      <ul class="list-disc list-inside text-slate-300 text-sm space-y-1">
        <li>Unlimited scans</li>
        <li>Tone presets</li>
        <li>Export history</li>
      </ul>
      <button class="w-full px-4 py-3 rounded-xl bg-slate-800 border border-slate-700 text-slate-200">Notify me</button>
    </div>
  </div>

  <script>
    (() => {
      const contextOptions = ['Dating', 'Work', 'Friends', 'Sales', 'Social'];
      const toneOptions = ['Confident', 'Warm', 'Flirty', 'Direct', 'Playful', 'Firm', 'Apologetic'];
      const nextMoveSuggestions = [
        'Ask one specific question to invite a reply.',
        'Tighten the message by 20% for clarity.',
        'Lead with your intent, then the ask.',
        'Acknowledge their position, then propose a step.',
        'Offer one clear option instead of three.',
        'Give them room to opt out gracefully.',
        'Add a single warm note before the ask.'
      ];

      const state = {
        history: JSON.parse(localStorage.getItem('vs_history') || '[]'),
        streak: JSON.parse(localStorage.getItem('vs_streak') || '{"count":0,"lastDate":null,"challengeDate":null}'),
        settings: JSON.parse(localStorage.getItem('vs_settings') || '{}'),
        scans: 0,
        dailyPrompt: ''
      };

      const els = {
        contextChips: document.getElementById('contextChips'),
        toneChips: document.getElementById('toneChips'),
        messageInput: document.getElementById('messageInput'),
        scanBtn: document.getElementById('scanBtn'),
        demoBtn: document.getElementById('demoBtn'),
        toneDial: document.getElementById('toneDial'),
        toneLabel: document.getElementById('toneLabel'),
        resultsSection: document.getElementById('resultsSection'),
        sliderContainer: document.getElementById('sliderContainer'),
        interpretations: document.getElementById('interpretations'),
        rewrites: document.getElementById('rewrites'),
        nextMove: document.getElementById('nextMove'),
        streakBar: document.getElementById('streakBar'),
        streakCount: document.getElementById('streakCount'),
        levelLabel: document.getElementById('levelLabel'),
        dailyPrompt: document.getElementById('dailyPrompt'),
        usePromptBtn: document.getElementById('usePromptBtn'),
        challengeStatus: document.getElementById('challengeStatus'),
        historyBtn: document.getElementById('historyBtn'),
        historyModal: document.getElementById('historyModal'),
        historyList: document.getElementById('historyList'),
        closeHistory: document.getElementById('closeHistory'),
        settingsBtn: document.getElementById('settingsBtn'),
        settingsModal: document.getElementById('settingsModal'),
        closeSettings: document.getElementById('closeSettings'),
        clearHistory: document.getElementById('clearHistory'),
        resetStreak: document.getElementById('resetStreak'),
        proToggle: document.getElementById('proToggle'),
        proModal: document.getElementById('proModal'),
        closePro: document.getElementById('closePro')
      };

      const selected = { context: 'Work', tones: [] };

      const dailyPrompts = [
        'Invite someone to coffee but keep it breezy.',
        'Decline a meeting while staying collaborative.',
        'Send a flirty opener about weekend plans.',
        'Follow up after a job interview with warmth.',
        'Set a boundary with a friend kindly.',
        'Pitch your idea in two sentences.',
        'Check in on someone who has been quiet.'
      ];

      function hashString(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          hash = (hash << 5) - hash + str.charCodeAt(i);
          hash |= 0;
        }
        return Math.abs(hash);
      }

      function pseudoRandom(hash, min = 0, max = 1) {
        const x = Math.sin(hash++) * 10000;
        return min + (x - Math.floor(x)) * (max - min);
      }

      function analyzeText(text, context, toneGoals, toneDial) {
        const baseHash = hashString(text + context + toneGoals.join(',') + toneDial);
        const cues = {
          exclamations: (text.match(/!/g) || []).length,
          questions: (text.match(/\?/g) || []).length,
          apologies: (text.match(/\b(sorry|apolog|forgive)\b/gi) || []).length,
          hedges: (text.match(/\b(kinda|maybe|just|perhaps|might|sort of|possibly)\b/gi) || []).length,
          length: text.length,
          doubleText: (text.match(/\?\?|!!|\.\.\./g) || []).length,
          lines: (text.match(/\n/g) || []).length
        };

        const profile = [
          { label: 'Confidence', value: 50 + pseudoRandom(baseHash, -10, 10) },
          { label: 'Warmth', value: 50 + pseudoRandom(baseHash / 2, -15, 15) },
          { label: 'Directness', value: 50 + pseudoRandom(baseHash / 3, -10, 12) },
          { label: 'Playfulness', value: 50 + pseudoRandom(baseHash / 5, -20, 20) },
          { label: 'Neediness-risk', value: 45 + pseudoRandom(baseHash / 7, -10, 20) }
        ];

        // Adjustments
        profile[0].value += cues.apologies ? -cues.apologies * 4 : 0;
        profile[1].value += cues.exclamations * 2 + cues.apologies * 3;
        profile[2].value += cues.questions * 3 - cues.hedges * 3;
        profile[3].value += cues.exclamations + cues.doubleText * 2;
        profile[4].value += cues.hedges * 4 + Math.max(0, cues.length - 220) / 25 + cues.doubleText * 5;
        profile.forEach(p => p.value = Math.max(5, Math.min(95, Math.round(p.value))));

        // Tone dial: <50 playful, >50 direct
        const dialShift = (toneDial - 50) / 10;
        profile[2].value += dialShift; // directness
        profile[3].value -= dialShift;
        profile[4].value += dialShift * 0.5;
        profile.forEach(p => p.value = Math.max(5, Math.min(95, Math.round(p.value))));

        // Tone goals nudge
        toneGoals.forEach(goal => {
          if (goal === 'Confident') profile[0].value += 4;
          if (goal === 'Warm') profile[1].value += 4;
          if (goal === 'Direct') profile[2].value += 4;
          if (goal === 'Playful' || goal === 'Flirty') profile[3].value += 5;
          if (goal === 'Apologetic') profile[4].value += 6;
          if (goal === 'Firm') { profile[2].value += 2; profile[4].value -= 2; }
        });
        profile.forEach(p => p.value = Math.max(5, Math.min(95, Math.round(p.value))));

        const interpretations = buildInterpretations(profile, cues, context);
        const rewrites = buildRewrites(text, toneGoals, toneDial, cues);
        const nextMove = pickNextMove(profile, cues);

        return { profile, interpretations, rewrites, nextMove };
      }

      function buildInterpretations(profile, cues, context) {
        const lines = [];
        const confidence = profile.find(p => p.label === 'Confidence').value;
        const warmth = profile.find(p => p.label === 'Warmth').value;
        const directness = profile.find(p => p.label === 'Directness').value;
        const playfulness = profile.find(p => p.label === 'Playfulness').value;
        const neediness = profile.find(p => p.label === 'Neediness-risk').value;

        lines.push(confidence > 65 ? 'Comes across as sure of self.' : 'May feel a bit tentative.');
        lines.push(warmth > 60 ? 'Carries warmth that keeps it human.' : 'Tone is neutral; could add a friendly cue.');
        lines.push(directness > 65 ? 'Very direct—efficient but mind the edges.' : 'Indirect—consider a clearer ask.');
        lines.push(playfulness > 60 ? 'Lighthearted energy is noticeable.' : 'Not much play; stays utilitarian.');
        lines.push(neediness > 60 ? 'Slight clingy signal from hedges or length.' : 'Low neediness risk; balanced pacing.');
        if (cues.questions > 1) lines.push('Multiple questions—prioritize one to reduce load.');
        if (context === 'Dating' && playfulness < 50) lines.push('Dating context could benefit from one playful beat.');
        if (cues.length > 240) lines.push('Message runs long; trimming will sharpen impact.');
        return lines.slice(0,5);
      }

      function shortenByPercentage(text, pct = 0.3) {
        const target = Math.max(40, Math.round(text.length * (1 - pct)));
        const words = text.split(/\s+/);
        let out = '';
        for (let i = 0; i < words.length && out.length < target; i++) {
          out += (out ? ' ' : '') + words[i];
        }
        return out.trim() + (out.length < text.length ? '…' : '');
      }

      function buildRewrites(text, toneGoals, toneDial, cues) {
        const base = text.trim();
        const rewriters = [];
        const sentences = base.split(/(?<=[.!?])\s+/);
        const lead = sentences[0] || base;
        const ask = cues.questions ? 'Could you share a quick update?' : 'Let me know what you think.';
        rewriters.push({
          title: 'Option A: Same words, cleaner',
          body: lead.replace(/\bjust\b/gi, '').replace(/!!+/g,'!').replace(/\?\?+/g,'?') + (sentences[1] ? ' ' + sentences.slice(1).join(' ') : '')
        });
        rewriters.push({
          title: 'Option B: More confident',
          body: `${lead} ${ask}`.trim().replace(/\bmaybe\b/gi,'').replace(/\bi think\b/gi,'I know')
        });
        rewriters.push({
          title: 'Option C: More warm/playful',
          body: `${lead} ${contextualWarmth(toneGoals)}`.trim()
        });
        if (base.length > 180) {
          rewriters.push({
            title: 'Bonus: Shorten by 30%',
            body: shortenByPercentage(base, 0.3)
          });
        }
        return rewriters;
      }

      function contextualWarmth(toneGoals) {
        const friendly = [
          'Appreciate you taking a look at this!',
          'Hope your day is going smoothly.',
          'Thanks for rolling with me on this.',
          'Excited to hear your take.'
        ];
        const playful = [
          'Let\'s make this easy together.',
          'Curious to hear your spice on it.',
          'Dropping this in with good vibes.',
          'Sending this with a grin.'
        ];
        const list = toneGoals.includes('Playful') || toneGoals.includes('Flirty') ? playful : friendly;
        return list[Math.floor(Math.random() * list.length)];
      }

      function pickNextMove(profile, cues) {
        let move = nextMoveSuggestions[Math.floor(Math.random() * nextMoveSuggestions.length)];
        const directness = profile.find(p => p.label === 'Directness').value;
        const neediness = profile.find(p => p.label === 'Neediness-risk').value;
        if (neediness > 65) move = 'Shorten it by 30% and make one clear ask.';
        else if (directness < 45) move = 'State the intent in the first sentence.';
        else if (cues.questions > 1) move = 'Pick the most important question and drop the rest.';
        return move;
      }

      function buildChips(container, options, multi, max = Infinity) {
        container.innerHTML = '';
        options.forEach(opt => {
          const btn = document.createElement('button');
          btn.textContent = opt;
          btn.className = 'px-3 py-2 rounded-xl bg-slate-900 border border-slate-800 hover:border-sky-400 text-sm';
          btn.addEventListener('click', () => {
            if (!multi) {
              selected.context = opt;
              Array.from(container.children).forEach(c => c.classList.remove('border-sky-400', 'text-sky-200'));
              btn.classList.add('border-sky-400','text-sky-200');
            } else {
              if (selected.tones.includes(opt)) {
                selected.tones = selected.tones.filter(t => t !== opt);
                btn.classList.remove('border-sky-400','text-sky-200');
              } else if (selected.tones.length < max) {
                selected.tones.push(opt);
                btn.classList.add('border-sky-400','text-sky-200');
              }
            }
          });
          if (!multi && opt === selected.context) btn.classList.add('border-sky-400','text-sky-200');
          container.appendChild(btn);
        });
      }

      function updateToneLabel(value) {
        const label = value < 35 ? 'More Playful' : value > 65 ? 'More Direct' : 'Balanced';
        els.toneLabel.textContent = label;
      }

      function showSkeleton() {
        els.resultsSection.classList.remove('opacity-0','pointer-events-none');
        els.sliderContainer.innerHTML = '';
        els.interpretations.innerHTML = '';
        els.rewrites.innerHTML = '';
        els.nextMove.textContent = '';
        for (let i = 0; i < 5; i++) {
          const row = document.createElement('div');
          row.className = 'h-6 rounded-lg bg-slate-800 shimmer';
          els.sliderContainer.appendChild(row);
        }
        for (let i = 0; i < 4; i++) {
          const row = document.createElement('div');
          row.className = 'h-4 rounded bg-slate-800 shimmer';
          els.interpretations.appendChild(row);
        }
        for (let i = 0; i < 3; i++) {
          const card = document.createElement('div');
          card.className = 'h-24 rounded-xl bg-slate-800 shimmer';
          els.rewrites.appendChild(card);
        }
        const nm = document.createElement('div');
        nm.className = 'h-6 w-2/3 rounded bg-slate-800 shimmer';
        els.nextMove.appendChild(nm);
      }

      function renderResults(result) {
        els.sliderContainer.innerHTML = '';
        result.profile.forEach(p => {
          const row = document.createElement('div');
          row.className = 'space-y-1';
          row.innerHTML = `
            <div class="flex items-center justify-between text-sm">
              <span>${p.label}</span>
              <span class="text-slate-400">${p.value}</span>
            </div>
            <div class="h-2.5 rounded-full bg-slate-800 overflow-hidden">
              <div class="h-full accent-bg" style="width:${p.value}%"></div>
            </div>`;
          els.sliderContainer.appendChild(row);
        });

        els.interpretations.innerHTML = '';
        result.interpretations.forEach(line => {
          const li = document.createElement('li');
          li.textContent = line;
          els.interpretations.appendChild(li);
        });

        els.rewrites.innerHTML = '';
        result.rewrites.slice(0,3).forEach(r => {
          const card = document.createElement('div');
          card.className = 'p-3 rounded-xl bg-slate-900 border border-slate-800 flex flex-col gap-3 fade-in';
          const copyBtn = document.createElement('button');
          copyBtn.textContent = 'Copy';
          copyBtn.className = 'self-start px-2 py-1 rounded-lg text-xs bg-white/5 hover:bg-white/10';
          copyBtn.addEventListener('click', () => navigator.clipboard.writeText(r.body));
          card.innerHTML = `<p class="font-semibold text-sm">${r.title}</p><p class="text-sm text-slate-300">${r.body}</p>`;
          card.appendChild(copyBtn);
          els.rewrites.appendChild(card);
        });

        els.nextMove.textContent = result.nextMove;
      }

      function saveHistory(entry) {
        state.history.unshift(entry);
        state.history = state.history.slice(0,20);
        localStorage.setItem('vs_history', JSON.stringify(state.history));
      }

      function updateStreak(challengeCompleted) {
        const today = new Date().toISOString().slice(0,10);
        if (challengeCompleted && state.streak.challengeDate !== today) {
          state.streak.count = state.streak.lastDate === today ? state.streak.count : state.streak.count + 1;
          state.streak.lastDate = today;
          state.streak.challengeDate = today;
        }
        localStorage.setItem('vs_streak', JSON.stringify(state.streak));
        els.streakCount.textContent = state.streak.count;
        const level = Math.min(5, 1 + Math.floor((state.scans + state.history.length) / 5));
        els.levelLabel.textContent = level;
        const fill = Math.min(100, ((state.history.length + state.scans) % 10) * 10);
        els.streakBar.style.width = `${fill}%`;
        els.challengeStatus.textContent = state.streak.challengeDate === today ? 'Completed today' : '';
      }

      function renderHistory() {
        els.historyList.innerHTML = '';
        if (!state.history.length) {
          els.historyList.innerHTML = '<p class="text-slate-400">No scans yet.</p>';
          return;
        }
        state.history.forEach(item => {
          const li = document.createElement('li');
          li.className = 'p-3 rounded-xl bg-slate-900 border border-slate-800 hover:border-sky-400 cursor-pointer';
          li.innerHTML = `<div class="flex justify-between text-xs text-slate-500"><span>${item.context}</span><span>${new Date(item.time).toLocaleString()}</span></div><p class="text-sm text-slate-200 mt-1">${item.text.slice(0,60)}${item.text.length>60?'…':''}</p>`;
          li.addEventListener('click', () => {
            els.messageInput.value = item.text;
            selected.context = item.context;
            selected.tones = item.tones || [];
            buildChips(els.contextChips, contextOptions, false);
            buildChips(els.toneChips, toneOptions, true,2);
            renderResults(item.analysis);
            els.resultsSection.classList.remove('opacity-0','pointer-events-none');
            els.historyModal.classList.add('hidden');
          });
          els.historyList.appendChild(li);
        });
      }

      function scan({ useChallenge = false } = {}) {
        const text = els.messageInput.value.trim();
        if (!text) return;
        showSkeleton();
        setTimeout(() => {
          const analysis = analyzeText(text, selected.context, selected.tones, Number(els.toneDial.value));
          renderResults(analysis);
          els.resultsSection.classList.remove('opacity-0','pointer-events-none');
          els.resultsSection.classList.add('fade-in');
          saveHistory({ time: Date.now(), text, context: selected.context, tones: [...selected.tones], analysis });
          state.scans += 1;
          updateStreak(useChallenge);
        }, 520);
      }

      function initDailyChallenge() {
        const idx = new Date().getDate() % dailyPrompts.length;
        state.dailyPrompt = dailyPrompts[idx];
        els.dailyPrompt.textContent = state.dailyPrompt;
      }

      // Event bindings
      buildChips(els.contextChips, contextOptions, false);
      buildChips(els.toneChips, toneOptions, true, 2);
      initDailyChallenge();
      updateToneLabel(els.toneDial.value);
      updateStreak(false);

      els.toneDial.addEventListener('input', (e) => updateToneLabel(e.target.value));
      els.scanBtn.addEventListener('click', () => scan({ useChallenge: els.messageInput.value.trim() === state.dailyPrompt }));
      els.demoBtn.addEventListener('click', () => {
        els.messageInput.value = 'Hey! Quick check—are we still on for tomorrow? Want to make sure I bring the right materials.';
        selected.context = 'Work';
        selected.tones = ['Warm','Confident'];
        buildChips(els.contextChips, contextOptions, false);
        buildChips(els.toneChips, toneOptions, true,2);
      });
      els.usePromptBtn.addEventListener('click', () => {
        els.messageInput.value = state.dailyPrompt;
        els.challengeStatus.textContent = 'Ready to scan';
      });

      els.historyBtn.addEventListener('click', () => { renderHistory(); els.historyModal.classList.remove('hidden'); els.historyModal.classList.add('flex'); });
      els.closeHistory.addEventListener('click', () => els.historyModal.classList.add('hidden'));
      els.historyModal.addEventListener('click', (e) => { if (e.target === els.historyModal) els.historyModal.classList.add('hidden'); });

      els.settingsBtn.addEventListener('click', () => els.settingsModal.classList.remove('hidden'));
      els.closeSettings.addEventListener('click', () => els.settingsModal.classList.add('hidden'));
      els.settingsModal.addEventListener('click', (e) => { if (e.target === els.settingsModal) els.settingsModal.classList.add('hidden'); });
      els.clearHistory.addEventListener('click', () => { state.history = []; localStorage.setItem('vs_history','[]'); renderHistory(); });
      els.resetStreak.addEventListener('click', () => { state.streak = {count:0,lastDate:null,challengeDate:null}; updateStreak(false); localStorage.setItem('vs_streak', JSON.stringify(state.streak)); });

      els.proToggle.addEventListener('click', () => els.proModal.classList.remove('hidden'));
      els.closePro.addEventListener('click', () => els.proModal.classList.add('hidden'));
      els.proModal.addEventListener('click', (e) => { if (e.target === els.proModal) els.proModal.classList.add('hidden'); });

      // Reveal demo if history exists
      if (state.history[0]) {
        els.messageInput.value = state.history[0].text;
        selected.context = state.history[0].context;
        selected.tones = state.history[0].tones || [];
        buildChips(els.contextChips, contextOptions, false);
        buildChips(els.toneChips, toneOptions, true,2);
        renderResults(state.history[0].analysis);
        els.resultsSection.classList.remove('opacity-0','pointer-events-none');
      }
    })();
  </script>
</body>
</html>
